---
title: "Cleaning SBA Loan Data Set"
author: "Yash Tambawala"
date: "March 9, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
# Starting the libraries
library(dplyr)
library(ROCR)
library(data.table)
```


# Input

## Reading the files 

We read the following data sets:
1. Unemployment Data Set
2. FED Interest Rate data per year. 
Source: https://fred.stlouisfed.org/series/DFF/downloaddata
3. Total economic cost due to Tornados per year per state.
Source: http://www.spc.noaa.gov/wcm/test.html (manipulated using R and excel)
4. Small Business Lending Stats per state for 2011
Source:
https://www.sba.gov/advocacy/firm-size-data  https://www.sba.gov/content/small-business-lending-united-states-2010-2011


```{r}
set.seed(1)
df <- read.csv("SBA_loan_data_new.csv")

# Macroeconomic data sets 

unemployment_data <- read.csv("emp-unemployment.csv")
interest_rates_data <- read.csv("FED_IR.csv")
Tornado_damage_economic <- read.csv("Tornado FL.csv")
Small_business_lending_data <- read.csv("Small_Business_lending_stats.csv")
GDPSectorData <- read.csv("GDP_Industry.csv")
TED <- read.csv("TEDRATE.csv")
SNP500 <- read.csv("SNP500.csv")
```

## Creating the SBLR and GDP data columns

```{r}
set.seed(1)
SBLR <- c(rep(0,length(df$BorrState)))

for (i in 1:length(df$BorrState)) {
  SBLR[i]=Small_business_lending_data[match(df$BorrState[i],Small_business_lending_data$State),5]
}

GDP <- c(rep(0,length(df$ApprovalFiscalYear)))
```

# Data Cleaning operations

We do the following things:
1. Add small business loan ratio (total small business loans issued/total small businesses per state )
2. Average HPI Index by State for 1990-2016
3. Filtering out Loans which are canceled or exempt

```{r}
set.seed(1)
#Add small business loan ratio (total small business loans issued/total small businesses per state)
df=cbind(df,SBLR)

# Average HPI Index by State for 1990-2016
hpi_state <- read.csv("hpi_state.csv", header=TRUE, stringsAsFactors=F)
hpi_state$ProjectState = as.factor(hpi_state$ProjectState)
df <- left_join(df, hpi_state, by=c("ProjectState", "ApprovalFiscalYear"))
df$mn_hpi = as.numeric(df$mn_hpi)

# Filtering out Loans which are canceled or exempt

df <- filter(df, LoanStatus != "CANCLD")
df <- filter(df, LoanStatus != "EXEMPT")
df <- filter(df, DeliveryMethod != "504REFI")
```

We now remove extra columns

1. Removing the first 3 columns of the data set  as they contain the common program info and a unique identifying name for every business
2. Removing the column BorrZip Code
3. Removing CDC street, city, zip
4. Adding 4 columns - isDefault, NotSameState, ThirdPartyApproved and dayselapsed
5. Conversion to factor
6. Removing the Third Party Lender Name, City, State
7. Removing subpgmdesc
8. Removing NAICS description
9. Removing Project County and State
10. Adding 2 digits NAICS code

```{r}
set.seed(1)
df <- subset(df,select = -c(Program,BorrName,BorrStreet,
                     BorrZip,CDC_Street,CDC_City,CDC_Zip))

# adding isDefault

df$isDefault <- ifelse(df$LoanStatus=="CHGOFF",1,0)
for (i in 1:nrow(df)) {
if(df$LoanStatus[i]=="PIF"){df$isDefault[i]= 0}} 
df$isDefault <- as.numeric(df$isDefault)

# factor conversion
df$NotSameState <- factor(df$NotSameState)
df$ThirdPartyApproved <- factor(df$ThirdPartyApproved)

# adding dayselaped
df <- mutate(df,dayselapsed = as.numeric(difftime(strptime(ChargeOffDate, format = "%m/%d/%Y"),
                                                  strptime(ApprovalDate, format = "%m/%d/%Y"))))

df$dayselapsed[is.na(df$dayselapsed)]=round(df$TermInMonths*30.4)
df$dayselapsed[is.na(df$dayselapsed)] <- 7300

# adding FinalYear
df$FinalYear=df$ApprovalFiscalYear+round((df$dayselapsed)/365)

# Removing extra columns
df <- subset(df,select = -c(ThirdPartyLender_Name,ThirdPartyLender_City,ThirdPartyLender_State,
                     subpgmdesc,NaicsDescription,ProjectCounty,ProjectState))

# adding Naics2digits
df <- mutate(df,Naics2digits = substr(NaicsCode,1,2))

```

We perform the following operations:
1. Getting Interest Rates table


```{r}
# Getting Interest Rates
set.seed(1)
interest_rates=matrix(0,nrow=length(df$ApprovalFiscalYear),ncol=length(1990:2014))
for (i in 1:length(1990:2014)) {
  interest_rates[,i]=interest_rates_data[match(1989+i,interest_rates_data$Year),2]
}
interest_rates = interest_rates[1,]

```


```{r}
  # Initializing Matrix for Adding columns
  set.seed(1)
  matrix_test=matrix(0,nrow=0,ncol=24)
  finalMatrix=matrix(0,nrow=0,ncol=24)
  tempRow = matrix(0,nrow=1,ncol=24)
  
  end_index=0
  
  x=c("loanNum","start","stop","interestRate","gdpIndustry","unemploymentRate","hpiState","tedSpread","sandp500",
      "BorrState","CDC_State","ThirdPartyDollars","GrossApproval","ApprovalDate","ApprovalFiscalYear","DeliveryMethod",
      "TermInMonths","BusinessType","NotSameState","SBLR","Naics2digits","Defaultyn","isDefault","endIndicator")
  
  colnames(matrix_test)=x
  
  df_const <- as.matrix(subset(df,select = c(BorrState,CDC_State,ThirdPartyDollars,GrossApproval,
                                             ApprovalDate,ApprovalFiscalYear,DeliveryMethod,
                                             TermInMonths,BusinessType,NotSameState,SBLR,Naics2digits,isDefault)))
  
  for (i in 1:nrow(df)) {
    start=df$ApprovalFiscalYear[i]
    stop=df$ApprovalFiscalYear[i]+round(df$dayselapsed[i]/365)
    periods=length(start:stop)     
    n=0
    unemployment_start_index=match(start,unemployment_data[1,])
    unemployment_state_index=match(df$BorrState[i],unemployment_data[,3])
    GDP_NAICS_index=match(df$Naics2digits[i],GDPSectorData[,2])
    GDP_start_index=match(start,GDPSectorData[1,])
    HPI_start_index=match(interaction(df$BorrState[i],start),
                          interaction(hpi_state$ProjectState, hpi_state$ApprovalFiscalYear))
    if(stop<=2014){
      for (j in 1:periods) { 
        tempRow = matrix(0,nrow=1,ncol=24)
        tempRow[1,1]=i
        tempRow[1,2]=start+n
        tempRow[1,3]=start+n+1
        tempRow[1,4] = interest_rates[start-1990+j]
        tempRow[1,5]=GDPSectorData[GDP_NAICS_index,GDP_start_index+n]
        tempRow[1,6]=unemployment_data[unemployment_state_index,unemployment_start_index+n]
        tempRow[1,7]=hpi_state[HPI_start_index+n,3]
        tempRow[1,8]=TED[start-1990+j,2]
        tempRow[1,9]=SNP500[start-1990+j,1]
        tempRow[1,as.numeric(10:22)] = df_const[i,]

        if(df$isDefault[i]==1){
          if((start+n)==stop){tempRow[1,23]=1
          tempRow[1,24]=1}
        }
        
        if(start+n==stop) {tempRow[1,24]=1}
        
        n=n+1 
        matrix_test <- rbind(matrix_test,tempRow)
      }
    
      
    }
    else{
      for (j in 1:(2014-start)) {
        tempRow = matrix(0,nrow=1,ncol=24)
        tempRow[1,1]=i
        tempRow[1,2]=start+n
        tempRow[1,3]=start+n+1
        tempRow[1,4]=interest_rates[start-1990+j]
        tempRow[1,5]=GDPSectorData[GDP_NAICS_index,GDP_start_index+n]
        tempRow[1,6]=unemployment_data[unemployment_state_index,unemployment_start_index+n]
        tempRow[1,7]=hpi_state[HPI_start_index+n,3]
        tempRow[1,8]=TED[start-1990+j,2]
        tempRow[1,9]=SNP500[start-1990+j,1]
        tempRow[1,10:22] = df_const[i,]
      
        if(df$isDefault[i]==1){
          if((start+n)==stop){tempRow[1,23]=1
          tempRow[1,24]=1}
        }
        
        if(unemployment_start_index+n==stop) {tempRow[1,24]=1}
        
        if(j==2014-start){tempRow[1,24]=1}
        
        n=n+1 
        matrix_test <- rbind(matrix_test,tempRow)
      }
    }
    if(nrow(matrix_test)>=1000){
      finalMatrix <- rbind(finalMatrix,matrix_test)
      matrix_test=matrix(0,nrow=0,ncol=24)
    }
  }
  

finalMatrix <- rbind(finalMatrix,matrix_test)
finalMatrix=as.data.frame(finalMatrix)

# Convert ApprovalDate
finalMatrix <- mutate(finalMatrix, ApprovalDate = as.numeric(difftime(strptime(ApprovalDate, format ="%m/%d/%Y"),strptime("1/1/1990", format = "%m/%d/%Y")))) 
finalMatrix$start <- as.numeric(as.character(finalMatrix$start))
finalMatrix$stop <- as.numeric(as.character(finalMatrix$stop))
finalMatrix$isDefault <- as.numeric(as.character(finalMatrix$isDefault))
finalMatrix$GrossApproval <- as.numeric(as.character(finalMatrix$GrossApproval))
finalMatrix$unemploymentRate <- as.numeric(as.character(finalMatrix$unemploymentRate))
finalMatrix$interestRate <- as.numeric(as.character(finalMatrix$interestRate))
finalMatrix$hpiState <- as.numeric(as.character(finalMatrix$hpiState))
finalMatrix$TermInMonths <- as.numeric(as.character(finalMatrix$TermInMonths))
finalMatrix$SBLR <- as.numeric(as.character(finalMatrix$SBLR))
finalMatrix$tedSpread <-as.numeric(as.character(finalMatrix$tedSpread))
finalMatrix$sandp500 <- as.numeric(as.character(finalMatrix$sandp500))
finalMatrix$loanNum <- as.numeric(as.character(finalMatrix$loanNum))
#finalMatrix$Defaultyn <- as.numeric(as.character(finalMatrix$loanNum))
finalMatrix$isDefault <- as.numeric(as.character(finalMatrix$LoanNum))
# Export file
write.csv(finalMatrix, file="big_data_Matrix.csv", col.names=FALSE)

```

# Split into training set and test set 

```{r}
set.seed(1)

filter500=filter(finalMatrix,TermInMonths>=60)
loans_sampled_test=sample(filter500$loanNum[1]:filter500$loanNum[nrow(filter500)],500,replace=FALSE)

loan_numbers=c(1:nrow(df))
loan_numbers=loan_numbers[-loans_sampled_test]
  
training_set_loan_numbers = sample(loan_numbers,round(0.80*length(loan_numbers)),replace=FALSE)
validation_set_loan_numbers= loan_numbers[-training_set_loan_numbers]

training_set <-  finalMatrix[(finalMatrix$loanNum %in% training_set_loan_numbers),]
validation_set <-  finalMatrix[(finalMatrix$loanNum %in% validation_set_loan_numbers),]
test500_set <- finalMatrix[(finalMatrix$loanNum %in% loans_sampled_test),]

training_set$Defaultyn=as.numeric(as.character(training_set$Defaultyn))
validation_set$Defaultyn=as.numeric(as.character(validation_set$Defaultyn))
test500_set$Defaultyn=as.numeric(as.character(test500_set$Defaultyn))

write.csv(training_set, file="training_set.csv", col.names=FALSE)
write.csv(validation_set, file="validation_set.csv", col.names=FALSE)
write.csv(test500_set, file="test500_set.csv", col.names=FALSE)

length(unique(validation_set$loanNum))+length(unique(training_set$loanNum))+length(unique(test500_set$loanNum))

sum(test500_set$isDefault)/length(unique(test500_set$loanNum))
sum(validation_set$isDefault)/length(unique(validation_set$loanNum))
sum(training_set$isDefault)/length(unique(training_set$loanNum))
```
# Cox Regression


```{r}

library(survival)
library(peperr)


matrix_test2=matrix(0,nrow=0,ncol=24)
  finalMatrix2=matrix(0,nrow=0,ncol=24)
  tempRow2 = matrix(0,nrow=1,ncol=24)
  
  end_index=0
  
  x=c("loanNum","start","stop","interestRate","gdpIndustry","unemploymentRate","hpiState","tedSpread","sandp500",
      "BorrState","CDC_State","ThirdPartyDollars","GrossApproval","ApprovalDate","ApprovalFiscalYear","DeliveryMethod",
      "TermInMonths","BusinessType","NotSameState","SBLR","Naics2digits","Defaultyn","isDefault","endIndicator")
  
  colnames(matrix_test)=x
  
  df_const2 <- as.matrix(subset(df_new,select = c(BorrState,CDC_State,ThirdPartyDollars,GrossApproval,
                                             ApprovalDate,ApprovalFiscalYear,DeliveryMethod,
                                             TermInMonths,BusinessType,NotSameState,SBLR,Naics2digits,isDefault)))
  
  df_new=df[loans_sampled_test,]
  
  
  for (i in 1:nrow(df_new)) {
    
    start=df_new$ApprovalFiscalYear[i]
    stop=df_new$ApprovalFiscalYear[i]+5
    periods=length(start:stop)     
    n=0
    chargeoffyear=df_new$ApprovalFiscalYear[i]+round(df_new$dayselapsed[i]/365)
    
    unemployment_start_index=match(start,unemployment_data[1,])
    unemployment_state_index=match(df_new$BorrState[i],unemployment_data[,3])
    GDP_NAICS_index=match(df_new$Naics2digits[i],GDPSectorData[,2])
    GDP_start_index=match(start,GDPSectorData[1,])
    HPI_start_index=match(interaction(df_new$BorrState[i],start),
                          interaction(hpi_state$ProjectState, hpi_state$ApprovalFiscalYear))
      for (j in 1:(stop-start)) { 
        tempRow2 = matrix(0,nrow=1,ncol=24)
        tempRow2[1,1]=i
        tempRow2[1,2]=start+n
        tempRow2[1,3]=start+n+1
        tempRow2[1,4]=interest_rates[start-1990+j]
        tempRow2[1,5]=GDPSectorData[GDP_NAICS_index,GDP_start_index+n]
        tempRow2[1,6]=unemployment_data[unemployment_state_index,unemployment_start_index+n]
        tempRow2[1,7]=hpi_state[HPI_start_index+n,3]
        tempRow2[1,8]=TED[start-1990+j,2]
        tempRow2[1,9]=SNP500[start-1990+j,1]
        tempRow2[1,as.numeric(10:22)] = df_const2[i,]

       if(df_new$isDefault[i]==1){
        if((start+n)==chargeoffyear){tempRow2[1,23]=1
         tempRow2[1,24]=1}
        }
        
        #if(start+n==stop) {tempRow[1,24]=1}
        
        n=n+1 
        matrix_test2 <- rbind(matrix_test2,tempRow2)
      }
    
   # if(nrow(matrix_test2)>=1000){
      #finalMatrix2 <- rbind(finalMatrix2,matrix_test2)
      #matrix_test2=matrix(0,nrow=0,ncol=24)
    #}
  }
  colnames(matrix_test2)=x
  test500_full <- matrix_test2
  test500_full <- as.data.frame(matrix_test2)
  
test500_full$start <- as.numeric(as.character(test500_full$start))
test500_full$stop <- as.numeric(as.character(test500_full$stop))
test500_full$isDefault <- as.numeric(as.character(test500_full$isDefault))
test500_full$GrossApproval <- as.numeric(as.character(test500_full$GrossApproval))
test500_full$unemploymentRate <- as.numeric(as.character(test500_full$unemploymentRate))
test500_full$interestRate <- as.numeric(as.character(test500_full$interestRate))
test500_full$hpiState <- as.numeric(as.character(test500_full$hpiState))
test500_full$TermInMonths <- as.numeric(as.character(test500_full$TermInMonths))
test500_full$SBLR <- as.numeric(as.character(test500_full$SBLR))
test500_full$tedSpread <-as.numeric(as.character(test500_full$tedSpread))
test500_full$sandp500 <- as.numeric(as.character(test500_full$sandp500))
test500_full$loanNum <- as.numeric(as.character(test500_full$loanNum))

test500_full$interestRate <- (as.factor(test500_full$interestRate))

View(test500_full)
  
write.csv(test500_full, file="test500_full.csv", col.names=FALSE)

pairs(test500_full[,4:ncol(test500_full)])

training_set$interestRate <- as.numeric(as.character(training_set$interestRate))

interestRatebucket=c(rep(0,nrow(training_set)))

for (i in 1:nrow(training_set)) 
{ if (training_set$interestRate[i]<= 2){interestRatebucket[i]="A"}
 # if (training_set$interestRate[i]<= 4 & training_set$interestRate[i]>2){interestRatebucket[i]="B"}
#  if (training_set$interestRate[i]<= 6 & training_set$interestRate[i]>4){interestRatebucket[i]="D"}
   if (training_set$interestRate[i]>2){interestRatebucket[i]="E"}
  
}


training_set=cbind(training_set,interestRatebucket)    

cox_reg=coxph(Surv(start,stop,isDefault)~1+GrossApproval+hpiState+interestRatebucket,
              data=training_set)

summary(cox_reg)

pred_cox_expected=predict(cox_reg,test500_full,type="expected")
cox_test500_cumulativeLambda = c(rep(0,(length(unique(test500_full$loanNum)))))

loanforecastyears=5

for (i in 1:length(unique(test500_full$loanNum))) {
  end_index=loanforecastyears*i
  start_index=end_index-(loanforecastyears-1)
  cox_test500_cumulativeLambda[i]=sum(pred_cox_expected[start_index:end_index])
  }

#Create a data set showing whether loans actually default within 5 year horizon


default_within_5=matrix(0,nrow=length(unique(test500_full$loanNum)),ncol=2)
default_within_5[,1]=unique(test500_full$loanNum)
x=c("loanNum","isDefault")
colnames(default_within_5)=x

for (i in 1:length(unique(test500_full$loanNum))) {
  
  end_index=loanforecastyears*i
  start_index=end_index-(loanforecastyears-1)
  
for (j in start_index:end_index)
  {
  if(test500_full$isDefault[j]==1) {
    default_within_5[i,2]=1
     }
      }
}

prob_default_cox = 1-exp(-cox_test500_cumulativeLambda)
cox_isDefault5=c(rep(0,length(prob_default_cox)))
cox_isDefault5[prob_default_cox>0.2] <- 1
default_within_5=as.data.frame(default_within_5)

confusion_matrix_cox_regression=table(cox_isDefault5,default_within_5$isDefault)
confusion_matrix_cox_regression

test_error= mean((cox_isDefault5-default_within_5$isDefault)^2)
test_error

pr <- prediction(cox_isDefault5,default_within_5$isDefault)

prf <- performance(pr,measure = "tpr",x.measure = "fpr")
plot(prf)


## COX REGRESSION ON VALIDATION SET


#filtered_validation_set=filter(validation_set,endIndicator==1)

#filtered_validation_set=validation_set

pred_cox_expected_validation=predict(cox_reg,validation_set,type="expected")


cox_testvalidation_cumulativeLambda = c(rep(0,(length(unique(validation_set$loanNum)))))

end_index=c(rep(0,length(unique(validation_set$loanNum))+1))
end_index[1]=1
l=2

for (j in 1:nrow(validation_set)) {
  if (validation_set$endIndicator[j]==1){
    end_index[l]=j
    l=l+1
  }
}
  
  
for (i in 1:length(unique(validation_set$loanNum))) {
  
  cox_testvalidation_cumulativeLambda[i]=sum(pred_cox_expected_validation[end_index[i]:end_index[i+1]])
  
  }

cox_prob_default_validation=1-exp(-cox_testvalidation_cumulativeLambda)
cox_isDefault_validation=c(rep(0,length(unique(validation_set$loanNum))))
cox_isDefault_validation[cox_prob_default_validation>0.5] <- 1
filtered_validation_set=filter(validation_set,endIndicator==1)
confusion_matrix_cox_regression=table(cox_isDefault_validation,filtered_validation_set$isDefault)
confusion_matrix_cox_regression

library(ROCR)
pr <- prediction(cox_isDefault_validation,filtered_validation_set$isDefault)
prf <- performance(pr,measure = "tpr",x.measure = "fpr")
plot(prf)


```

