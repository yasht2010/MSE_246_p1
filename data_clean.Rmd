---
title: "Cleaning SBA Loan Data Set"
author: "Yash Tambawala"
date: "March 9, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
# Starting the libraries
library(dplyr)
library(ROCR)
library(data.table)
```


# Input

## Reading the files 

We read the following data sets:
1. Unemployment Data Set
2. FED Interest Rate data per year. 
Source: https://fred.stlouisfed.org/series/DFF/downloaddata
3. Total economic cost due to Tornados per year per state.
Source: http://www.spc.noaa.gov/wcm/test.html (manipulated using R and excel)
4. Small Business Lending Stats per state for 2011
Source:
https://www.sba.gov/advocacy/firm-size-data  https://www.sba.gov/content/small-business-lending-united-states-2010-2011


```{r}
set.seed(1)
df <- read.csv("SBA_loan_data_new.csv")

# Macroeconomic data sets 

unemployment_data <- read.csv("emp-unemployment.csv")
interest_rates_data <- read.csv("FED_IR.csv")
Tornado_damage_economic <- read.csv("Tornado FL.csv")
Small_business_lending_data <- read.csv("Small_Business_lending_stats.csv")
GDPSectorData <- read.csv("GDP_Industry.csv")
```

## Creating the SBLR and GDP data columns

```{r}
SBLR <- c(rep(0,length(df$BorrState)))

for (i in 1:length(df$BorrState)) {
  SBLR[i]=Small_business_lending_data[match(df$BorrState[i],Small_business_lending_data$State),5]
}

GDP <- c(rep(0,length(df$ApprovalFiscalYear)))
```

# Data Cleaning operations

We do the following things:
1. Add small business loan ratio (total small business loans issued/total small businesses per state )
2. Average HPI Index by State for 1990-2016
3. Filtering out Loans which are canceled or exempt

```{r}
#Add small business loan ratio (total small business loans issued/total small businesses per state )
df=cbind(df,SBLR)

# Average HPI Index by State for 1990-2016
hpi_state <- read.csv("hpi_state.csv", header=TRUE, stringsAsFactors=F)
hpi_state$ProjectState = as.factor(hpi_state$ProjectState)
df <- left_join(df, hpi_state, by=c("ProjectState", "ApprovalFiscalYear"))
df$mn_hpi = as.numeric(df$mn_hpi)

# Filtering out Loans which are canceled or exempt

df <- filter(df, LoanStatus != "CANCLD")
df <- filter(df, LoanStatus != "EXEMPT")
df <- filter(df, DeliveryMethod != "504REFI")
```

We now remove extra columns

1. Removing the first 3 columns of the data set  as they contain the common program info and a unique identifying name for every business
2. Removing the column BorrZip Code
3. Removing CDC street, city, zip
4. Adding 4 columns - isDefault, NotSameState, ThirdPartyApproved and dayselapsed
5. Conversion to factor
6. Removing the Third Party Lender Name, City, State
7. Removing subpgmdesc
8. Removing NAICS description
9. Removing Project County and State
10. Adding 2 digits NAICS code

```{r}
df <- subset(df,select = -c(Program,BorrName,BorrStreet,
                     BorrZip,CDC_Street,CDC_City,CDC_Zip))

# adding isDefault

df$isDefault <- ifelse(df$LoanStatus=="CHGOFF",1,0)
for (i in 1:nrow(df)) {
if(df$LoanStatus[i]=="PIF"){df$isDefault[i]= 2}} 
df$isDefault <- factor(df$isDefault)
df$isDefault <- as.numeric(df$isDefault)

# factor conversion
df$NotSameState <- factor(df$NotSameState)
df$ThirdPartyApproved <- factor(df$ThirdPartyApproved)

# adding dayselaped
df <- mutate(df,dayselapsed = as.numeric(difftime(strptime(ChargeOffDate, format = "%m/%d/%Y"),
                                                  strptime(ApprovalDate, format = "%m/%d/%Y"))))

df$dayselapsed[is.na(df$dayselapsed)]=round(df$TermInMonths*30.4)
df$dayselapsed[is.na(df$dayselapsed)] <- 7300

# adding FinalYear
df$FinalYear=df$ApprovalFiscalYear+round((df$dayselapsed)/365)

# Removing extra columns
df <- subset(df,select = -c(ThirdPartyLender_Name,ThirdPartyLender_City,ThirdPartyLender_State,
                     subpgmdesc,NaicsDescription,ProjectCounty,ProjectState))

# adding Naics2digits
df <- mutate(df,Naics2digits = substr(NaicsCode,1,2))

```

We perform the following operations:
1. Getting Interest Rates table


```{r}
# Getting Interest Rates
interest_rates=matrix(0,nrow=length(df$ApprovalFiscalYear),ncol=length(1990:2014))
for (i in 1:length(1990:2014)) {
  interest_rates[,i]=interest_rates_data[match(1989+i,interest_rates_data$Year),2]
}
interest_rates = interest_rates[1,]

```


```{r}
# Initializing Matrix for Adding columns
matrix_test=matrix(0,nrow=0,ncol=15)
finalMatrix=matrix(0,nrow=0,ncol=15)
tempRow = matrix(0,nrow=1,ncol=15)

end_index=0

x=c("Loan Number","Start","Stop","Interest Rate","Default","Date of Loan Termination","ApprovalFiscalYear",
    "GrossApproval","BusinessType","NaicsCode","UnemploymentRate","SBLR","DefaultTime","GDP Industry","HPI_state")
colnames(matrix_test)=x

df_const <- as.matrix(subset(df,select = c(SBLR,isDefault,ApprovalFiscalYear,
                     GrossApproval,BusinessType,NaicsCode)))

for (i in 1:15000) {
  #print(i)
  start=df$ApprovalFiscalYear[i]
  stop=df$ApprovalFiscalYear[i]+round(df$dayselapsed[i]/365)
  periods=length(start:stop)     
  n=0
  unemployment_start_index=match(start,unemployment_data[1,])
  unemployment_state_index=match(df$BorrState[i],unemployment_data[,3])
  GDP_NAICS_index=match(df$Naics2digits[i],GDPSectorData[,2])
  GDP_start_index=match(start,GDPSectorData[1,])
  HPI_start_index=match(interaction(df$BorrState[i],start),
                        interaction(hpi_state$ProjectState, hpi_state$ApprovalFiscalYear))
  if(stop<=2014){
    for (j in 1:periods) { 
      tempRow = matrix(0,nrow=1,ncol=15)
      tempRow[1,1]=i
      #matrix_test[end_index+j,1]=i 
      #index_start=start-1989
      tempRow[1,2]=start+n
      tempRow[1,3]=start+n+1
      
      #matrix_test[end_index+j,2]= start+n
      #matrix_test[end_index+j,3]= start+n+1
      tempRow[1,4] = interest_rates[start-1990+j]
      #matrix_test[end_index+j,4]= interest_rates[start-1990+j]
      tempRow[1,c(12,5,7,8,9,10)] = df_const[i,]
      #matrix_test[end_index+j,c(12,5,7,8,9,10)]= df_const[i,]
      #matrix_test[end_index+j,12]=df$SBLR[i]
      #matrix_test[end_index+j,5]= df$isDefault[i]
      #matrix_test[end_index+j,7]= df$ApprovalFiscalYear[i]
      #matrix_test[end_index+j,8]= df$GrossApproval[i]
      #matrix_test[end_index+j,9]= df$BusinessType[i]
      #matrix_test[end_index+j,10]= df$NaicsCode[i]
      tempRow[1,11]=unemployment_data[unemployment_state_index,unemployment_start_index+n]
      #matrix_test[end_index+j,11]=unemployment_data[unemployment_state_index,unemployment_start_index+n]
      tempRow[1,14]=GDPSectorData[GDP_NAICS_index,GDP_start_index+n]
      #matrix_test[end_index+j,14]=GDPSectorData[GDP_NAICS_index,GDP_start_index+n]
      tempRow[1,15]=hpi_state[HPI_start_index+n,3]
      #matrix_test[end_index+j,15]=hpi_state[HPI_start_index+n,3]
      
      if(df$isDefault[i]==2){
        tempRow[1,6]=stop
        if((start+n)==stop){tempRow[1,13]=1}
        #matrix_test[end_index+j,6]=stop
        #matrix_test[end_index+periods,13]=1
        }
      else {tempRow[1,6]=2040} #matrix_test[end_index+j,6]= 2040
      n=n+1 
      matrix_test <- rbind(matrix_test,tempRow)
    }
    
  }
  else{
    #print("a")
    for (j in 1:(2014-start)) {
      tempRow = matrix(0,nrow=1,ncol=15)
      tempRow[1,1] = i
      #matrix_test[end_index+j,1]=i 
      #index_start=start-1989
      tempRow[1,2]=start+n
      tempRow[1,3]=start+n+1
      tempRow[1,4]=interest_rates[start-1990+j]
      tempRow[1,c(12,5,7,8,9)]= df_const[i]
      #matrix_test[end_index+j,2]= start+n
      #matrix_test[end_index+j,3]= start+n+1
      #matrix_test[end_index+j,4]= interest_rates[start-1990+j] 
      #matrix_test[end_index+j,c(12,5,7,8,9)]= df_const[i]
      #matrix_test[end_index+j,12]=df$SBLR[i]
      #matrix_test[end_index+j,5]= df$isDefault[i]
      #matrix_test[end_index+j,7]= df$ApprovalFiscalYear[i]
      #matrix_test[end_index+j,8]= df$GrossApproval[i]
      #matrix_test[end_index+j,9]= df$BusinessType[i]
      #matrix_test[end_index+j,10]= df$NaicsCode[i]
      tempRow[1,11]=unemployment_data[unemployment_state_index,unemployment_start_index+n]
      #matrix_test[end_index+j,11]=unemployment_data[unemployment_state_index,unemployment_start_index+n]
      tempRow[1,14]=GDPSectorData[GDP_NAICS_index,GDP_start_index+n]
      #matrix_test[end_index+j,14]=GDPSectorData[GDP_NAICS_index,GDP_start_index+n]
      tempRow[1,15]=hpi_state[HPI_start_index+n,3]
     #matrix_test[end_index+j,15]=hpi_state[HPI_start_index+n,3]
      
      
      if(df$isDefault[i]==2) {
        tempRow[1,6]=stop
        if((start+n)==stop){tempRow[1,13]=1}
        #matrix_test[end_index+j,6]=stop
        #matrix_test[end_index+periods,13]=1
        }
      else {tempRow[1,6]=2040}# matrix_test[end_index+j,6]= 2040 
      n=n+1 
      matrix_test <- rbind(matrix_test,tempRow)
      
      
    }
  }
  #a=length(which(matrix_test[,1]==0))

  if(nrow(matrix_test)>=1000){
    finalMatrix <- rbind(finalMatrix,matrix_test)
    matrix_test=matrix(0,nrow=0,ncol=15)
  }
}
finalMatrix <- rbind(finalMatrix,matrix_test)

finalMatrix=as.data.frame(finalMatrix)

```

