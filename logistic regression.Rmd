---
title: "logistic regression"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(dplyr)
library(ROCR)
library(glmnet)

## LOGISTIC REGRESSION
## LOGISTIC REGRESSION

# Constructing Model
set.seed(2)
training_set = read.csv("training_set.csv")
sum(training_set$isDefault)
sum(training_set$isDefault)/length(unique(training_set$loanNum))
test_set = read.csv("validation_set.csv")
test500_set = read.csv("test500_full.csv")
sum(test_set$isDefault)
sum(test_set$isDefault)/length(unique(test_set$loanNum))
sum(test500_set$isDefault)/length(unique(test500_set$loanNum))
log_reg=glm(isDefault ~ GrossApproval+hpiState+sandp500+unemploymentRate+interestRate,family=binomial,data=training_set)

summary(log_reg)
#predict of test_set w/o splitting time periods
pred_log_reg=predict(log_reg,test_set,type="response")
pred_log_reg
log_reg_predict_values = c(rep(0,nrow(test_set)))
log_reg_predict_values[pred_log_reg>0.07] <-1 
table(log_reg_predict_values, test_set$isDefault)

# pred_log_reg - Conditional Prob of Default
# test_set = validation set

loan_indices <- as.data.frame(unique(test_set$loanNum))
loan_indices$start <- 1
loan_indices$stop <- 1
colnames(loan_indices) <- c("loan_no","start","stop")
l = 1
counter = 1

# find start and stop for each loan
for(i in 1:nrow(test_set)){
  if(test_set$endIndicator[i]==1){
    loan_indices$stop[l]=i
    l=l+1
    if(l<=nrow(loan_indices)){
    loan_indices$start[l]=i+1
    }
  }
}

pred_test <- rep(0,length(pred_log_reg))

for(i in 1:nrow(loan_indices))
{
  a = loan_indices$start[i]
  b = loan_indices$stop[i]
  for(j in a:b){
    print("a")
    if(j==a){
      pred_test[a]=pred_log_reg[a]
    }
    else{
      for(k in a:j){
        counter = counter*(1-pred_log_reg[k])
      }
       pred_test[j]=1-counter
    }
    counter = 1
  }
}

pred_test_val <- rep(0,length(pred_log_reg))
pred_test_val[pred_test>0.08] <-1 
table(pred_test_val,test_set$isDefault)

# for loop over start and stop for each loan

## if i = 1 => Prob of default is just the cond. prob
## if i>1
### for loop from 1 to i-1
#### multiply with survival
### multiply with default in i


#ROC Curve
library(ROCR)
#does not work if no loans defaulted. Only works when there are two classes.
pred1 = prediction(pred_test, test_set$isDefault)
perf1 = performance(pred1, "tpr", "fpr")
plot(perf1)
auc1 <- performance(pred1,measure = "auc")
auc1 <- auc1@y.values[[1]]
auc1
```