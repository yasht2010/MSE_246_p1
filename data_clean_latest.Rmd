---
title: "Cleaning SBA Loan Data Set"
author: "Yash Tambawala"
date: "March 9, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
# Starting the libraries
library(dplyr)
library(ROCR)
library(data.table)
```


# Input

## Reading the files 

We read the following data sets:
1. Unemployment Data Set
2. FED Interest Rate data per year. 
Source: https://fred.stlouisfed.org/series/DFF/downloaddata
3. Total economic cost due to Tornados per year per state.
Source: http://www.spc.noaa.gov/wcm/test.html (manipulated using R and excel)
4. Small Business Lending Stats per state for 2011
Source:
https://www.sba.gov/advocacy/firm-size-data  https://www.sba.gov/content/small-business-lending-united-states-2010-2011


```{r}
set.seed(1)
df <- read.csv("SBA_loan_data_new.csv")

# Macroeconomic data sets 

unemployment_data <- read.csv("emp-unemployment.csv")
interest_rates_data <- read.csv("FED_IR.csv")
Tornado_damage_economic <- read.csv("Tornado FL.csv")
Small_business_lending_data <- read.csv("Small_Business_lending_stats.csv")
GDPSectorData <- read.csv("GDP_Industry.csv")
TED <- read.csv("TEDRATE.csv")
SNP500 <- read.csv("SNP500.csv")
```

## Creating the SBLR and GDP data columns

```{r}
set.seed(1)
SBLR <- c(rep(0,length(df$BorrState)))

for (i in 1:length(df$BorrState)) {
  SBLR[i]=Small_business_lending_data[match(df$BorrState[i],Small_business_lending_data$State),5]
}

GDP <- c(rep(0,length(df$ApprovalFiscalYear)))
```

# Data Cleaning operations

We do the following things:
1. Add small business loan ratio (total small business loans issued/total small businesses per state )
2. Average HPI Index by State for 1990-2016
3. Filtering out Loans which are canceled or exempt

```{r}
set.seed(1)
#Add small business loan ratio (total small business loans issued/total small businesses per state)
df=cbind(df,SBLR)

# Average HPI Index by State for 1990-2016
hpi_state <- read.csv("hpi_state.csv", header=TRUE, stringsAsFactors=F)
hpi_state$ProjectState = as.factor(hpi_state$ProjectState)
df <- left_join(df, hpi_state, by=c("ProjectState", "ApprovalFiscalYear"))
df$mn_hpi = as.numeric(df$mn_hpi)

# Filtering out Loans which are canceled or exempt

df <- filter(df, LoanStatus != "CANCLD")
df <- filter(df, LoanStatus != "EXEMPT")
df <- filter(df, DeliveryMethod != "504REFI")
```

We now remove extra columns

1. Removing the first 3 columns of the data set  as they contain the common program info and a unique identifying name for every business
2. Removing the column BorrZip Code
3. Removing CDC street, city, zip
4. Adding 4 columns - isDefault, NotSameState, ThirdPartyApproved and dayselapsed
5. Conversion to factor
6. Removing the Third Party Lender Name, City, State
7. Removing subpgmdesc
8. Removing NAICS description
9. Removing Project County and State
10. Adding 2 digits NAICS code

```{r}
set.seed(1)
df <- subset(df,select = -c(Program,BorrName,BorrStreet,
                     BorrZip,CDC_Street,CDC_City,CDC_Zip))

# adding isDefault

df$isDefault <- ifelse(df$LoanStatus=="CHGOFF",1,0)
for (i in 1:nrow(df)) {
if(df$LoanStatus[i]=="PIF"){df$isDefault[i]= 2}} 
df$isDefault <- factor(df$isDefault)
df$isDefault <- as.numeric(df$isDefault)

# factor conversion
df$NotSameState <- factor(df$NotSameState)
df$ThirdPartyApproved <- factor(df$ThirdPartyApproved)

# adding dayselaped
df <- mutate(df,dayselapsed = as.numeric(difftime(strptime(ChargeOffDate, format = "%m/%d/%Y"),
                                                  strptime(ApprovalDate, format = "%m/%d/%Y"))))

df$dayselapsed[is.na(df$dayselapsed)]=round(df$TermInMonths*30.4)
df$dayselapsed[is.na(df$dayselapsed)] <- 7300

# adding FinalYear
df$FinalYear=df$ApprovalFiscalYear+round((df$dayselapsed)/365)

# Removing extra columns
df <- subset(df,select = -c(ThirdPartyLender_Name,ThirdPartyLender_City,ThirdPartyLender_State,
                     subpgmdesc,NaicsDescription,ProjectCounty,ProjectState))

# adding Naics2digits
df <- mutate(df,Naics2digits = substr(NaicsCode,1,2))

```

We perform the following operations:
1. Getting Interest Rates table


```{r}
# Getting Interest Rates
set.seed(1)
interest_rates=matrix(0,nrow=length(df$ApprovalFiscalYear),ncol=length(1990:2014))
for (i in 1:length(1990:2014)) {
  interest_rates[,i]=interest_rates_data[match(1989+i,interest_rates_data$Year),2]
}
interest_rates = interest_rates[1,]

```


```{r}
  # Initializing Matrix for Adding columns
  set.seed(1)
  matrix_test=matrix(0,nrow=0,ncol=23)
  finalMatrix=matrix(0,nrow=0,ncol=23)
  tempRow = matrix(0,nrow=1,ncol=23)
  
  end_index=0
  
  x=c("loanNum","start","stop","interestRate","gdpIndustry","unemploymentRate","hpiState","tedSpread","sandp500",
      "BorrState","CDC_State","ThirdPartyDollars","GrossApproval","ApprovalDate","ApprovalFiscalYear","DeliveryMethod",
      "TermInMonths","BusinessType","NotSameState","SBLR","Naics2digits","isDefault","endIndicator")
  
  colnames(matrix_test)=x
  
  df_const <- as.matrix(subset(df,select = c(BorrState,CDC_State,ThirdPartyDollars,GrossApproval,
                                             ApprovalDate,ApprovalFiscalYear,DeliveryMethod,
                                             TermInMonths,BusinessType,NotSameState,SBLR,Naics2digits)))
  
  for (i in 1:nrow(df)) {
    start=df$ApprovalFiscalYear[i]
    stop=df$ApprovalFiscalYear[i]+round(df$dayselapsed[i]/365)
    periods=length(start:stop)     
    n=0
    unemployment_start_index=match(start,unemployment_data[1,])
    unemployment_state_index=match(df$BorrState[i],unemployment_data[,3])
    GDP_NAICS_index=match(df$Naics2digits[i],GDPSectorData[,2])
    GDP_start_index=match(start,GDPSectorData[1,])
    HPI_start_index=match(interaction(df$BorrState[i],start),
                          interaction(hpi_state$ProjectState, hpi_state$ApprovalFiscalYear))
    if(stop<=2014){
      for (j in 1:periods) { 
        tempRow = matrix(0,nrow=1,ncol=23)
        tempRow[1,1]=i
        tempRow[1,2]=start+n
        tempRow[1,3]=start+n+1
        tempRow[1,4] = interest_rates[start-1990+j]
        tempRow[1,5]=GDPSectorData[GDP_NAICS_index,GDP_start_index+n]
        tempRow[1,6]=unemployment_data[unemployment_state_index,unemployment_start_index+n]
        tempRow[1,7]=hpi_state[HPI_start_index+n,3]
        tempRow[1,8]=TED[start-1990+j,2]
        tempRow[1,9]=SNP500[start-1990+j,1]
        tempRow[1,as.numeric(10:21)] = df_const[i,]
          if(df$isDefault[i]==2){
          if((start+n)==stop){tempRow[1,22]=1
          tempRow[1,23]=1}
        }
        
        if(start+n==stop) {tempRow[1,23]=1}
        
        n=n+1 
        matrix_test <- rbind(matrix_test,tempRow)
      }
    
      
    }
    else{
      for (j in 1:(2014-start)) {
        tempRow = matrix(0,nrow=1,ncol=23)
        tempRow[1,1]=i
        tempRow[1,2]=start+n
        tempRow[1,3]=start+n+1
        tempRow[1,4]=interest_rates[start-1990+j]
        tempRow[1,5]=GDPSectorData[GDP_NAICS_index,GDP_start_index+n]
        tempRow[1,6]=unemployment_data[unemployment_state_index,unemployment_start_index+n]
        tempRow[1,7]=hpi_state[HPI_start_index+n,3]
        tempRow[1,8]=TED[start-1990+j,2]
        tempRow[1,9]=SNP500[start-1990+j,1]
        tempRow[1,10:21] = df_const[i,]
        if(df$isDefault[i]==2){
          if((start+n)==stop){tempRow[1,22]=1
          tempRow[1,23]=1}
        }
        
        if(unemployment_start_index+n==stop) {tempRow[1,23]=1}
        
        if(j==2014-start){tempRow[1,23]=1}
        
        n=n+1 
        matrix_test <- rbind(matrix_test,tempRow)
      }
    }
    if(nrow(matrix_test)>=1000){
      finalMatrix <- rbind(finalMatrix,matrix_test)
      matrix_test=matrix(0,nrow=0,ncol=23)
    }
  }
  

finalMatrix <- rbind(finalMatrix,matrix_test)
finalMatrix=as.data.frame(finalMatrix)

# Convert ApprovalDate
finalMatrix <- mutate(finalMatrix, ApprovalDate = as.numeric(difftime(strptime(ApprovalDate, format ="%m/%d/%Y"),strptime("1/1/1990", format = "%m/%d/%Y")))) 
finalMatrix$start <- as.numeric(as.character(finalMatrix$start))
finalMatrix$stop <- as.numeric(as.character(finalMatrix$stop))
finalMatrix$isDefault <- as.numeric(as.character(finalMatrix$isDefault))
finalMatrix$GrossApproval <- as.numeric(as.character(finalMatrix$GrossApproval))
finalMatrix$unemploymentRate <- as.numeric(as.character(finalMatrix$unemploymentRate))
finalMatrix$interestRate <- as.numeric(as.character(finalMatrix$interestRate))
finalMatrix$hpiState <- as.numeric(as.character(finalMatrix$hpiState))
finalMatrix$TermInMonths <- as.numeric(as.character(finalMatrix$TermInMonths))
finalMatrix$SBLR <- as.numeric(as.character(finalMatrix$SBLR))
finalMatrix$tedSpread <-as.numeric(as.character(finalMatrix$tedSpread))
finalMatrix$sandp500 <- as.numeric(as.character(finalMatrix$sandp500))
finalMatrix$loanNum <- as.numeric(as.character(finalMatrix$loanNum))

# Export file
#write.csv(finalMatrix, file="big_data_Matrix.csv", col.names=FALSE)

```

# Split into training set and test set 

```{r}
set.seed(1)
training_set=finalMatrix[1:520847,]
test_set=finalMatrix[520848+1:nrow(finalMatrix),]
filtered_set=filter(test_set,ApprovalFiscalYear==2008,TermInMonths>=60)
filtered_set=filter(filtered_set,start==2008)
loans_sampled_test=sample(filtered_set$loanNum[1]:filtered_set$loanNum[nrow(filtered_set)],500,replace=FALSE)
loans_sampled_test=as.numeric(loans_sampled_test)
validation_set <- test_set[!(test_set$loanNum %in% loans_sampled_test),]
test500_set <- test_set[(test_set$loanNum %in% loans_sampled_test),]


```
# Cox Regression
```{r}


library(survival)
library(peperr)

## COX REGRESSION
#cox_reg <- coxph(Surv(start,stop,isDefault)~sandp500,data=training_set)
cox_reg=coxph(Surv(start,stop,isDefault)~GrossApproval+unemploymentRate+hpiState+
                SBLR+TermInMonths,
              data=training_set)

singulartest <- lm(sandp500~GrossApproval+unemploymentRate+hpiState+BusinessType+TermInMonths+SBLR,data=training_set)

time_eval=c(2008,2009,2010, 2011, 2012)
time_eval2=2008

test_set_time_eval=filter(test_set,start==time_eval)
test_set_time_eval2=filter(test_set,start==time_eval2)



#test_set_final_year=filter(test_set)

s.scr <- survival::Surv(rep(2, nrow(test_set_time_eval)),rep(1, nrow(test_set_time_eval)) )   
s.scr2 <- survival::Surv(rep(2, nrow(test_set_time_eval2)),rep(1, nrow(test_set_time_eval2)) )   

pred_cox_model= predictProb.coxph(cox_reg,s.scr,test_set_time_eval,time_eval)
pred_cox_model2=predictProb.coxph(cox_reg,s.scr2,test_set_time_eval2,time_eval2)

matrix_verify=rep(0,nrow(pred_cox_model))

pred_cox_model=na.omit(pred_cox_model)

for (i in 1:nrow(pred_cox_model)) {
  if ((pred_cox_model[i,2]-pred_cox_model[i,1])>0) {matrix_verify[i]=1}  
  if ((pred_cox_model[i,3]-pred_cox_model[i,2])>0) {matrix_verify[i]=1}  
  if ((pred_cox_model[i,4]-pred_cox_model[i,3])>0) {matrix_verify[i]=1}  
  if ((pred_cox_model[i,5]-pred_cox_model[i,4])>0) {matrix_verify[i]=1} 
  
  }




pred_cox_model

pred = predict(cox_reg,test_set,type="expected")

prob_default=1-exp(pred)

plot(survfit(cox_reg),ylim=c(0.6,1),xlim=c(1990,2014))
summary(cox_reg)


## LOGISTIC REGRESSION

log_reg=glm(isDefault ~ GrossApproval+hpiState+TermInMonths+SBLR+sandp500+unemploymentRate+BusinessType,family=binomial,data=training_set)
pred_log_reg=predict(log_reg,test_set,type="response")

log_reg_predict_values=c(rep(0,nrow(test_set)))
log_reg_predict_values[pred_log_reg>0.5] <-1 

```


# Loss given default

```{r}

# Set up loss training set
loss_train <- filter(training_set, isDefault == 1)
chg_vals <- select(df, GrossChargeOffAmount)
chg_vals$loanNum <- c(1:nrow(df))
loss_train <- left_join(loss_train, chg_vals, by="loanNum") # adding charge off values

# Set up loss validation set
loss_valid <- filter(test_set, isDefault == 1)
loss_valid <- left_join(loss_valid, chg_vals, by="loanNum") # adding charge off values

# Training loss model
loss.mod <- lm(GrossChargeOffAmount~interestRate+unemploymentRate+hpiState+tedSpread+GrossApproval+TermInMonths+SBLR, data=loss_train)
summary(loss.mod)

# Testing loss model, computing MSE
loss.pred <- predict(loss.mod, newdata=loss_valid)
loss.pred
loss.mse <- mean((loss_valid$GrossChargeOffAmount-loss.pred)^2)
loss.mse

```


